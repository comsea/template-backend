<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <title>Articles</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <!-- jQuery (requis) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Trumbowyg -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/trumbowyg@2.28.0/dist/ui/trumbowyg.min.css">
    <script src="https://cdn.jsdelivr.net/npm/trumbowyg@2.28.0/dist/trumbowyg.min.js"></script>

    <style>
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 16px;
        }

        .card {
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 8px;
        }

        .row {
            display: flex;
            gap: 8px;
            margin: 8px 0;
        }

        img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <header class="row" style="justify-content:space-between; align-items:center;">
        <h1>Articles</h1>
        <nav class="row">
            <a href="/login.html">Login</a>
            <a href="/register.html">Register</a>
            <button id="logout">Logout</button>
        </nav>
    </header>

    <section>
        <h2>Créer un article</h2>
        <form id="create-form" enctype="multipart/form-data">
            <input name="title" placeholder="Titre" required />
            <input type="file" name="image" accept="image/*" />
            <textarea id="editor" name="content"></textarea>
            <button type="submit">Publier</button>
        </form>
        <p id="create-msg"></p>
    </section>

    <script src="/vendor/quill/quill.min.js"></script>
    <hr />

    <section>
        <h2>Publications</h2>
        <div id="list" class="grid"></div>
    </section>

    <script>
        $('#editor').trumbowyg({
            btns: [
                ['bold', 'italic', 'underline'],
                ['fontsize']   // taille de police
            ],
            autogrow: true
        });

        function sanitizeHtml(html) {
            const allowedTags = new Set(["P", "BR", "B", "STRONG", "I", "EM", "U", "SPAN"]);
            const tpl = document.createElement("template");
            tpl.innerHTML = html || "";

            (function walk(node) {
                if (node.nodeType === 1) {
                    const el = node;
                    if (!allowedTags.has(el.tagName)) {
                        const parent = el.parentNode;
                        while (el.firstChild) parent.insertBefore(el.firstChild, el);
                        parent.removeChild(el);
                        walk(parent);
                        return;
                    }
                    // supprime tous les attributs
                    for (const a of Array.from(el.attributes)) el.removeAttribute(a.name);
                    // autorise uniquement font-size sur <span>
                    if (el.tagName === "SPAN") {
                        const s = el.style.fontSize || "";
                        el.removeAttribute("style");
                        if (/^\d+(\.\d+)?(px|rem|em|%)$/.test(s)) el.style.fontSize = s;
                    }
                }
                for (const c of Array.from(node.childNodes)) walk(c);
            })(tpl.content);

            return tpl.innerHTML;
        }

        const list = document.getElementById("list");
        const token = localStorage.getItem("token");
        const createForm = document.getElementById("create-form");
        const createMsg = document.getElementById("create-msg");

        document.getElementById("logout").onclick = () => {
            localStorage.removeItem("token");
            location.reload();
        };

        createForm.style.display = token ? "block" : "none";

        async function load() {
            const res = await fetch("/articles");
            const json = await res.json();
            if (Array.isArray(json.data)) render(json.data);
        }

        function render(articles) {
            list.innerHTML = "";
            articles
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .forEach(a => {
                    const card = document.createElement("div");
                    card.className = "card";
                    const safe = sanitizeHtml(a.content ?? "");

                    card.innerHTML = `
        <h3>${escapeHtml(a.title)}</h3>
        ${a.image ? `<img src="${escapeAttr(a.image)}" alt="">` : ""}
        <div class="content"></div>
        <small>${new Date(a.createdAt).toLocaleString()}</small>
        ${token ? `
          <div class="row">
            <button data-id="${a.id}" class="edit">Edit</button>
            <button data-id="${a.id}" class="del">Delete</button>
          </div>` : ``}
      `;
                    card.querySelector(".content").innerHTML = safe;
                    list.appendChild(card);
                });

            list.querySelectorAll(".del").forEach(btn => {
                btn.addEventListener("click", async () => {
                    if (!confirm("Supprimer cet article ?")) return;
                    const id = btn.getAttribute("data-id");
                    const res = await fetch(`/articles/${id}`, {
                        method: "DELETE",
                        headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
                    });
                    if (res.ok) load();
                });
            });

            list.querySelectorAll(".edit").forEach(btn => {
                btn.addEventListener("click", async () => {
                    const id = btn.getAttribute("data-id");
                    const title = prompt("Nouveau titre ? (laisser vide pour ne pas changer)");
                    const content = prompt("Nouveau contenu ? (laisser vide pour ne pas changer)");
                    // Pour changer l'image à l'édition, tu peux faire un petit formulaire modal.
                    const body = JSON.stringify({ ...(title ? { title } : {}), ...(content ? { content } : {}) });
                    const res = await fetch(`/articles/${id}`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${localStorage.getItem("token")}`
                        },
                        body
                    });
                    if (res.ok) load();
                });
            });
        }

        createForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            createMsg.textContent = "Envoi...";
            try {
                const formData = new FormData(createForm);

                // ⚠️ Trumbowyg stocke le HTML directement dans le <textarea>
                formData.set("content", $('#editor').trumbowyg('html'));

                const res = await fetch("/articles", {
                    method: "POST",
                    headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
                    body: formData
                });
                const json = await res.json();
                if (!res.ok) throw new Error(json.error || "Erreur");

                createMsg.textContent = "Créé ✅";
                createForm.reset();
                $('#editor').trumbowyg('empty');
                load();
            } catch (err) {
                createMsg.textContent = err.message;
            }
        });


        function escapeHtml(s = "") { return s.replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m])) }
        function escapeAttr(s = "") { return s.replace(/"/g, "&quot;") }

        load();
    </script>
</body>

</html>